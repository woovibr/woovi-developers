---
id: webhook-hmac
title: Validando Webhook payload usando HMAC-SHA1 (Recomendado)
tags:
- webhook
- security
- hmac
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Validação HMAC (Método Recomendado)

A validação HMAC é o **método mais seguro** para validar webhooks da Woovi.

## Qual a diferença entre X-OpenPix-Signature (HMAC) e x-webhook-signature?

Existem dois métodos de validação de webhook disponíveis:

| Método | Header | O que valida | Chave utilizada |
|--------|--------|--------------|-----------------|
| **HMAC** | `X-OpenPix-Signature` | Valida que o webhook veio da **sua configuração específica de webhook** | Secret key do seu webhook |
| **x-webhook-signature** | `x-webhook-signature` | Valida que o webhook veio da **Woovi** (valida o remetente) | Chave pública da Woovi |

### Por que HMAC é mais seguro?

- **Secret key única**: Cada webhook possui sua própria secret key, conhecida apenas por você e pela Woovi.
- **Validação específica**: Garante que o webhook veio da sua configuração específica, não apenas de qualquer conta Woovi.
- **Proteção contra replay attacks**: A secret key exclusiva dificulta ataques de replay.

Se você deseja apenas validar que o webhook veio da Woovi (sem garantir que é do seu webhook específico), pode usar o método [x-webhook-signature](./webhook-signature-validation).

:::tip Recomendação
Sempre que possível, utilize a validação **HMAC (X-OpenPix-Signature)** para maior segurança.
:::

# Como consultar o Secret Key do HMAC?

Vá até o Menu Administrador e procure por `API/Plugins` e clique no Webhook que você gostaria de consultar o Secret Key do HMAC.

![WebhookDetail](/img/webhook/webhook-hmac.png)

# Como validar o HMAC Signature?

Toda request do Webhook possui o header `X-OpenPix-Signature` que é a assinatura gerada com a **secret key do seu Webhook** e o payload do Webhook.
Ao receber o header você pode validar se o HMAC é válido e dar continuidade no fluxo do Webhook.

Exemplo: `'X-OpenPix-Signature': 'jgR2XF0PKDiAwHP1s+TryvxMySQ='`

## Exemplo de validação

<Tabs
defaultValue="PHP"
    values={[
      { label: 'PHP'      , value: 'PHP', },
      { label: 'JavaScript', value: 'JavaScript', }, 
      { label: 'cURL', value: 'cURL', }, 
    ]
}>
<TabItem value="PHP" >

```php
  <?php 
    $headers['X-OpenPix-Signature'] = 'jgR2XF0PKDiAwHP1s+TryvxMySQ='; // vira da chamada do webhook
    $body = '{"data_criacao":"2021-08-10T20:32:14.429Z","evento":"teste_webhook","event":"OPENPIX:CHARGE_COMPLETED"}'; // vira da chamada do webhook

    $secretKeyOnOpenpixPlatform = 'hmac-secret-key'; // secret key da chave de acesso do OpenPix

    $algorithm = 'sha1'; // algoritmo de hash

    $hmac = base64_encode(hash_hmac($algorithm, $body, $secretKeyOnOpenpixPlatform, true));

    if($hmac === $headers['X-OpenPix-Signature']) {
        echo 'Valid HMAC';
    } else {
        echo 'Invalid HMAC';
    }
  ?>

```

</TabItem>
<TabItem value="JavaScript">

```jsx

  const createHmac = require('crypto').createHmac;

  const hmacCalculateSignature = (
    key,
    body,
    encoding,
  ) => createHmac('sha1', key).update(body).digest(encoding);

  const hmacVerifySignature = () => {

    const openpixSignatureHeader = 'jgR2XF0PKDiAwHP1s+TryvxMySQ='; // vem da chamada do webhook

    const body = '{"data_criacao":"2021-08-10T20:32:14.429Z","evento":"teste_webhook","event":"OPENPIX:CHARGE_COMPLETED"}'; // vem da chamada do webhook

    const key = 'hmac-secret-key'; // secret key da chave de acesso do OpenPix

    const signature = hmacCalculateSignature(key, body, 'base64');

    if(signature === openpixSignatureHeader) {
      console.log('valid HMAC');
    }
  };

  hmacVerifySignature();
  
```

</TabItem>
<TabItem value="cURL">

  ```bash

  echo -n '{"data_criacao":"2021-08-10T20:32:14.429Z","evento":"teste_webhook","event":"OPENPIX:CHARGE_COMPLETED"}' | openssl dgst -sha1 -hmac "hmac-secret-key" -binary | base64

  ```
</TabItem>
</Tabs>

:::info

O campo `event` enviado junto ao payload do webhook tem seu valor conforme o tipo de evento que você escolheu no momento em que criou o webhook.
Para saber mais sobre os tipos de eventos, acesse a [documentação de eventos](./webhook-events-type).

:::

Nesse link temos um exemplo de validação do HMAC usando JavaScript
[WebhookPost](https://github.com/Open-Pix/node-backend-integration/blob/master/src/webhook/webhookPost.ts)
